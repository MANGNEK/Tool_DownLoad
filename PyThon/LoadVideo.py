from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
import time
import logging
from Down import download_video

# ·∫®n log c·ªßa Selenium
logging.getLogger("selenium").setLevel(logging.CRITICAL)

def setup_driver(use_profile=False):
    options = Options()
    options.add_argument("--log-level=3")        # T·∫Øt log tr√¨nh duy·ªát
    options.add_argument("--mute-audio")         # T·∫Øt √¢m thanh c·ªßa Chrome
    #options.add_argument("--headless=new")       # Ch·∫°y Chrome ·∫©n (t√πy ch·ªçn)
    
    if use_profile:
        options.add_argument("--user-data-dir=C:/Users/trung/AppData/Local/Google/Chrome/User Data")
        options.add_argument("--profile-directory=Default")

    driver = webdriver.Chrome(options=options)
    return driver

def download_single_video(driver):
    time.sleep(5)
    try:
        video_element = driver.find_element(By.CSS_SELECTOR, ".kwai-player-container-video video")
        video_src = video_element.get_attribute("src")
        if video_src:
            download_video(video_src)
            print("‚úÖ ƒê√£ t·∫£i xong video!")
        else:
            print("‚ùå Kh√¥ng t√¨m th·∫•y video.")
    except Exception as e:
        print("‚ùå L·ªói khi t·∫£i video:", e)

def download_batch_videos(driver, count):
    try:
        first_video = driver.find_element(By.CLASS_NAME, "video-card-main")
        first_video.click()
    except:
        print("‚ùå Kh√¥ng t√¨m th·∫•y video ƒë·∫ßu ti√™n.")
        return
    
    while count > 0:
        time.sleep(2)
        try:
            # T√¨m th·∫ª video trong class "kwai-player-container-video"
            video_element = driver.find_element(By.CSS_SELECTOR, ".kwai-player-container-video video")
            video_src = video_element.get_attribute("src")
            if video_src:
                download_video(video_src)
                print(f"‚úÖ ƒê√£ t·∫£i video {count}")

            # Click v√†o n√∫t "Next"
            next_button = driver.find_element(By.CSS_SELECTOR, ".switch-item.video-switch-next")
            next_button.click()
        except Exception as e:
            print("‚ùå Kh√¥ng t√¨m th·∫•y video ho·∫∑c ƒë√£ h·∫øt danh s√°ch.", e)
            break

        count -= 1

def main():
    while True:
        print("\nüîπ Ch·ªçn ch·∫ø ƒë·ªô t·∫£i video:")
        print("1 - T·∫£i 1 video")
        print("2 - T·∫£i h√†ng lo·∫°t")
        print("0 - Tho√°t")
        choice = input("Nh·∫≠p s·ªë (0, 1, 2): ")

        if choice == "0":
            print("üëã Tho√°t ch∆∞∆°ng tr√¨nh!")
            break

        url = input("Nh·∫≠p v√†o URL mu·ªën t·∫£i: ")  # Nh·∫≠p URL tr∆∞·ªõc
        print(f"üåê ƒêang m·ªü URL: {url}")

        driver = setup_driver(use_profile=True)
        driver.get(url)  # M·ªü trang web tr∆∞·ªõc
        time.sleep(5)  # Ch·ªù trang t·∫£i xong

        if choice == "1":
            download_single_video(driver)
        elif choice == "2":
            count = int(input("üìå Nh·∫≠p s·ªë l∆∞·ª£ng video mu·ªën t·∫£i: "))
            download_batch_videos(driver, count)
        else:
            print("‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!")

        driver.quit()
        print("‚úÖ Ho√†n th√†nh!")

if __name__ == "__main__":
    main()
